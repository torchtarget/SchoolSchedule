<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pickup Schedule</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<h1>Pickup Schedule</h1>
<form id="scheduleForm" method="post">
{% for week in schedule %}
  {% set w = loop.index0 %}
  <div class="week-block">
    <button type="button" class="remove-week" data-week="{{ w }}">Remove Week</button>
    <div class="week-grid">
      <div class="row header-row">
        <div class="label-cell">Week {{ week.week_start.strftime('%W') }}</div>
        {% for date in get_week_dates(week.week_start) %}
          <div class="cell">{{ date }}</div>
        {% endfor %}
      </div>
      {% for key, label in [('pick_up_1', 'Pick AM'), ('pick_up_2', 'Pick PM')] %}
        <div class="row">
          <div class="label-cell">{{ label }}</div>
          {% for d in range(days|length) %}
            <div class="cell">
              <div class="parent-container">
                <div class="parent">
                  <span class="parent-label">M</span>
                  <input type="hidden" id="w{{ w }}_{{ key }}_m{{ d }}" name="w{{ w }}_{{ key }}_m{{ d }}" value="{{ week[key][d][0] }}">
                  <span class="status-icon" data-input="w{{ w }}_{{ key }}_m{{ d }}">{{ status_defs[week[key][d][0]].html|safe }}</span>
                </div>
                <div class="parent">
                  <span class="parent-label">F</span>
                  <input type="hidden" id="w{{ w }}_{{ key }}_f{{ d }}" name="w{{ w }}_{{ key }}_f{{ d }}" value="{{ week[key][d][1] }}">
                  <span class="status-icon" data-input="w{{ w }}_{{ key }}_f{{ d }}">{{ status_defs[week[key][d][1]].html|safe }}</span>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>
  </div>
{% endfor %}
</form>
<button type="button" id="addWeek">Add Week</button>
<h2>Legend</h2>
<ul class="legend">
  {% for code, details in status_defs|dictsort %}
    <li>{{ details.html|safe }} : {{ details.desc }}</li>
  {% endfor %}
</ul>
<script>
  const statusDefs = {{ status_defs | tojson }};
  const codes = Object.keys(statusDefs);
  const form = document.getElementById('scheduleForm');

  function autoSave(){
    const data = new FormData(form);
    fetch('/', {method: 'POST', body: data});
  }

  document.querySelectorAll('.status-icon').forEach(function(el){
    el.addEventListener('click', function(){
      const input = document.getElementById(el.dataset.input);
      const idx = codes.indexOf(input.value);
      const next = codes[(idx + 1) % codes.length];
      input.value = next;
      el.innerHTML = statusDefs[next].html;
      autoSave();
    });
  });

  document.getElementById('addWeek').addEventListener('click', function(){
    fetch('/add_week', {method: 'POST'}).then(() => location.reload());
  });

  document.querySelectorAll('.remove-week').forEach(function(btn){
    btn.addEventListener('click', function(){
      const idx = btn.dataset.week;
      fetch(`/remove_week/${idx}`, {method: 'POST'}).then(() => location.reload());
    });
  });
</script>
</body>
</html>
