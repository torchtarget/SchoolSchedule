<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pickup Schedule</title>
  <style>
    table { border-collapse: collapse; margin-bottom: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
    th { background: #d9ead3; }
    tr.date-row { background: #cfe2f3; font-weight: bold; }
    td.label-cell { font-weight: bold; text-align: left; }
    .status-icon { cursor: pointer; }
    .parent-container { display: flex; }
    .parent { flex: 1; display: flex; flex-direction: column; align-items: center; }
    .parent-label { font-size: 0.7em; margin-bottom: 2px; }
    ul.legend { list-style: none; padding: 0; }
    ul.legend li { margin-bottom: 5px; }
    ul.legend span { display: inline-block; min-width: 20px; text-align: center; margin-right: 10px; }
    .status-tick { color: #fff; background: green; font-weight: bold; padding: 2px 4px; border-radius: 3px; }
    .status-cross { color: red; font-weight: bold; }
    .status-travel { color: blue; font-style: italic; }
    .status-office { color: gray; }
    .status-unknown { color: purple; font-weight: bold; }
  </style>
</head>
<body>
<h1>Pickup Schedule</h1>
<form method="post">
{% for week in schedule %}
  {% set w = loop.index0 %}
  <table>
    <tr class="date-row">
      <td class="label-cell">Week {{ week.week_start.strftime('%W') }}</td>
      {% for date in get_week_dates(week.week_start) %}
        <th>{{ date }}</th>
      {% endfor %}
    </tr>
    {% for key, label in [('pick_up_1', 'Pick AM'), ('pick_up_2', 'Pick PM')] %}
      <tr>
        <td class="label-cell">{{ label }}</td>
        {% for d in range(days|length) %}
          <td>
            <div class="parent-container">
              <div class="parent">
                <span class="parent-label">M</span>
                <input type="hidden" id="w{{ w }}_{{ key }}_m{{ d }}" name="w{{ w }}_{{ key }}_m{{ d }}" value="{{ week[key][d][0] }}">
                <span class="status-icon" data-input="w{{ w }}_{{ key }}_m{{ d }}">{{ status_defs[week[key][d][0]].html|safe }}</span>
              </div>
              <div class="parent">
                <span class="parent-label">F</span>
                <input type="hidden" id="w{{ w }}_{{ key }}_f{{ d }}" name="w{{ w }}_{{ key }}_f{{ d }}" value="{{ week[key][d][1] }}">
                <span class="status-icon" data-input="w{{ w }}_{{ key }}_f{{ d }}">{{ status_defs[week[key][d][1]].html|safe }}</span>
              </div>
            </div>
          </td>
        {% endfor %}
      </tr>
    {% endfor %}
  </table>
{% endfor %}
  <button type="submit">Save</button>
</form>
<h2>Legend</h2>
<ul class="legend">
  {% for code, details in status_defs|dictsort %}
    <li>{{ details.html|safe }} : {{ details.desc }}</li>
  {% endfor %}
</ul>
<script>
  const statusDefs = {{ status_defs | tojson }};
  const codes = Object.keys(statusDefs);
  document.querySelectorAll('.status-icon').forEach(function(el){
    el.addEventListener('click', function(){
      const input = document.getElementById(el.dataset.input);
      const idx = codes.indexOf(input.value);
      const next = codes[(idx + 1) % codes.length];
      input.value = next;
      el.innerHTML = statusDefs[next].html;
    });
  });
</script>
</body>
</html>
